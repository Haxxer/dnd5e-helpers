<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/RestEffects.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/RestEffects.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { logger } from '../logger.js';
import { MODULE } from '../module.js';

const NAME = "RestEffects";

export class RestEffects{
  static register(){
    logger.info("Registering Rest Effect Deletion");
    RestEffects.defaults();
    RestEffects.settings();
    RestEffects.hooks();
    RestEffects.patch();
  }

  static defaults(){
    MODULE[NAME] = {
      /*
        Options require localization
      */
      options : ["Ignore", "Short Rest", "Long Rest"],
      key : "rest-effect",
    }
  }

  static settings(){

  }
  
  static hooks(){
    Hooks.on(`renderActiveEffectConfig`, RestEffects._renderActiveEffectConfig);
  }

  static patch(){
    RestEffects._patchActor();
  }

  /*
    Class Specific Functions
  */
  /**
   * _renderActiveEffectConfig is a hook method to display setting in active effects
   * @param {*} app 
   * @param {*} html 
   * @todo add conditions, might not be required
   * @todo localize labeling
   */
  static _renderActiveEffectConfig(app, html){
    const status = app.object.getFlag(MODULE.data.name, MODULE[NAME].key) ?? "";
    const tab = html.find('[data-tab="duration"]')[1];
    const selectHTML = `&lt;label> Remove after Rest &lt;/label>
                        &lt;div class="form-fields">
                          &lt;select name="flags.${MODULE.data.name}.${MODULE[NAME].key}" data-dtype="String">
                            ${MODULE[NAME].options.reduce((a,v) => a+=`&lt;option value="${v}" ${status == v ? `selected` : ``}>${v}&lt;/option>`, ``)}
                          &lt;/select>
                        &lt;/div>`;

    html.css("height", "auto");
    tab.append(MODULE.stringToDom(selectHTML, "form-group"));
  }

  //@todo possibly add additional information to what effects were removed to the last chatmessage
  static _patchActor(){
    //patch long rest
    const orig_longRest = getDocumentClass("Actor").prototype.longRest;
    getDocumentClass("Actor").prototype.longRest = async function({ dialog = true, chat = true, newDay = true} = {}){
      let result = await orig_longRest.call(this, {dialog, chat, newDay});
      if(result !== undefined)
        for(let effect of this.effects){
          let status = effect.getFlag(MODULE.data.name, MODULE[NAME].key) ?? "";
          if(status === "Short Rest" || status === "Long Rest")
            await effect.delete();
        }
      return result;
    }

    //patch short rest
    const orig_shortRest = getDocumentClass("Actor").prototype.shortRest;
    getDocumentClass("Actor").prototype.shortRest = async function({dialog = true, chat = true, autoHD = false, autoHDThreshold = 3}={}){
      let result = await orig_shortRest.call(this, {dialog, chat, autoHD, autoHDThreshold});
      if(result !== undefined){
        for(let effect of this.effects){
          let status = effect.getFlag(MODULE.data.name, MODULE[NAME].key) ?? "";
          if(status === "Short Rest")
            await effect.delete();
        }
      }
      return result;
    }
  }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ActionDialog.html">ActionDialog</a></li><li><a href="ActionManagement.html">ActionManagement</a></li><li><a href="DnDWildMagic.html">DnDWildMagic</a></li><li><a href="HelpersSettingsConfig.html">HelpersSettingsConfig</a></li><li><a href="LairActionDialog.html">LairActionDialog</a></li><li><a href="LairActionManagement.html">LairActionManagement</a></li><li><a href="LegendaryActionDialog.html">LegendaryActionDialog</a></li><li><a href="LegendaryActionManagement.html">LegendaryActionManagement</a></li><li><a href="UpdateQueue.html">UpdateQueue</a></li><li><a href="WildMagicAPI.html">WildMagicAPI</a></li><li><a href="WildMagicSurge.html">WildMagicSurge</a></li></ul><h3>Global</h3><ul><li><a href="global.html#handler">handler</a></li><li><a href="global.html#preCheck">preCheck</a></li><li><a href="global.html#queueUpdate">queueUpdate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sun Mar 27 2022 21:58:41 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
